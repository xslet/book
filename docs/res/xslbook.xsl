<?xml version="1.0" encoding="UTF-8"?><xsl:stylesheet xmlns:ut="https://github.com/sttk/xslet/2019/xslutil" xmlns:bk="https://github.com/sttk/xslet/2019/xslbook" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"><xsl:param name="bk:xsl_url"><xsl:call-template name="ut:get_xsl_url"/></xsl:param><xsl:param name="bk:xsl_dir"><xsl:call-template name="ut:get_dir_from_url"><xsl:with-param name="url" select="$bk:xsl_url"/></xsl:call-template></xsl:param><xsl:param name="bk:preface_index_format"/><xsl:param name="bk:chapter_index_format">1.</xsl:param><xsl:param name="bk:appendix_index_format">A.</xsl:param><xsl:param name="bk:postface_index_format"/><xsl:param name="bk:clause_index_format">1.</xsl:param><xsl:param name="bk:section_index_format">1.</xsl:param><xsl:param name="bk:default_toc_target"><xsl:text>|preface|chapter|appendix|postface|clause|</xsl:text></xsl:param><xsl:param name="bk:default_toc_title">Table of contents</xsl:param><xsl:param name="bk:default_navi_prev">previous</xsl:param><xsl:param name="bk:default_navi_next">next</xsl:param><xsl:param name="bk:default_navi_toc">table of contents</xsl:param><xsl:param name="bk:toc_url"><xsl:choose><xsl:when test="contains(/xslbook/@toc, '#')"><xsl:value-of select="substring-before(/xslbook/@toc, '#')"/></xsl:when><xsl:otherwise><xsl:value-of select="/xslbook/@toc"/></xsl:otherwise></xsl:choose></xsl:param><xsl:param name="bk:page_index"><xsl:call-template name="bk:get_page_index"/></xsl:param><xsl:param name="bk:page_url"><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:value-of select="(.//page)[position() = $bk:page_index]/@href"/></xsl:for-each></xsl:param><xsl:param name="bk:previous_page_url"><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:value-of select="(.//page)[position() = $bk:page_index - 1]/@href"/></xsl:for-each></xsl:param><xsl:param name="bk:next_page_url"><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:value-of select="(.//page)[position() = $bk:page_index + 1]/@href"/></xsl:for-each></xsl:param><xsl:template match="/xslbook"><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"/></xsl:variable><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><xsl:call-template name="bk:write_window_title"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template><xsl:call-template name="bk:write_default_css_link"/><xsl:apply-templates select="css"/><xsl:call-template name="bk:write_default_script_link"/><xsl:apply-templates select="script"/></head><body><header><xsl:call-template name="bk:write_navi_header"/></header><main><section class="xslbook"><xsl:call-template name="bk:set_id"/><xsl:call-template name="bk:write_book_title"><xsl:with-param name="data_url" select="$_data_url"/></xsl:call-template><xsl:apply-templates select="body|toc|preface|chapter|appendix|postface"><xsl:with-param name="data_url" select="$_data_url"/></xsl:apply-templates></section></main><footer><xsl:call-template name="bk:write_navi_footer"/></footer></body></html></xsl:template><xsl:template name="bk:get_data_url"><xsl:param name="data_url"/><xsl:choose><xsl:when test="boolean(@data-src)"><xsl:value-of select="@data-src"/></xsl:when><xsl:otherwise><xsl:value-of select="$data_url"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="bk:write_window_title"><xsl:param name="data_url"/><title><xsl:choose><xsl:when test="boolean(/xslbook/title)"><xsl:apply-templates select="/xslbook/title[1]"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></xsl:when><xsl:when test="string-length($bk:toc_url) &gt; 0"><xsl:for-each select="document($bk:toc_url,/)"><xsl:apply-templates select="/xslbook/title[1]"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></xsl:for-each></xsl:when></xsl:choose></title></xsl:template><xsl:template name="bk:write_book_title"><xsl:param name="data_url"/><xsl:if test="boolean(/xslbook/title)"><h1 class="title"><xsl:apply-templates select="/xslbook/title[1]"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></h1></xsl:if></xsl:template><xsl:template match="/xslbook/css"><xsl:choose><xsl:when test="boolean(@href)"><link rel="stylesheet" href="{@href}"/></xsl:when><xsl:when test="boolean(@rpath)"><link rel="stylesheet" href="{concat($bk:xsl_dir, '/', @rpath)}"/></xsl:when></xsl:choose></xsl:template><xsl:template match="/xslbook/script"><xsl:choose><xsl:when test="boolean(@href)"><script src="{@href}"/></xsl:when><xsl:when test="boolean(@rpath)"><script src="{concat($bk:xsl_dir, '/', @rpath)}"/></xsl:when></xsl:choose></xsl:template><xsl:template name="bk:write_default_css_link"><xsl:if test="not(boolean(css))"><link rel="stylesheet" href="{concat($bk:xsl_dir, '/xslbook.css')}"/></xsl:if></xsl:template><xsl:template name="bk:write_default_script_link"><script src="{concat($bk:xsl_dir, '/xslbook.js')}"/></xsl:template><xsl:template name="bk:set_id"><xsl:attribute name="id"><xsl:call-template name="bk:get_id"/></xsl:attribute></xsl:template><xsl:template name="bk:get_id"><xsl:choose><xsl:when test="boolean(@id)"><xsl:value-of select="@id"/></xsl:when><xsl:otherwise><xsl:text>idxbk</xsl:text><xsl:variable name="_tag_name" select="local-name()"/><xsl:value-of select="$_tag_name"/><xsl:number level="any" format="1" count="*[local-name() = $_tag_name]"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="body"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><div class="body"><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/></xsl:apply-templates></div></xsl:template><xsl:template name="bk:get_page_index"><xsl:if test="string-length($bk:toc_url) &gt; 0"><xsl:variable name="_index"><xsl:choose><xsl:when test="system-property('xsl:vendor') = 'Transformiix'"><xsl:call-template name="bk:_get_page_index_by_gid"/></xsl:when></xsl:choose></xsl:variable><xsl:choose><xsl:when test="string-length($_index) &gt; 0"><xsl:value-of select="$_index"/></xsl:when><xsl:otherwise><xsl:call-template name="bk:_get_page_index_by_titles"/></xsl:otherwise></xsl:choose></xsl:if></xsl:template><xsl:template name="bk:_get_page_index_by_gid"><xsl:variable name="_this_gid" select="generate-id(/)"/><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:for-each select=".//page"><xsl:if test="generate-id(document(@href,/)) = $_this_gid"><xsl:value-of select="position()"/></xsl:if></xsl:for-each></xsl:for-each></xsl:template><xsl:template name="bk:_get_page_index_by_titles"><xsl:variable name="_this_titles"><xsl:apply-templates select="//title"/></xsl:variable><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:for-each select=".//page"><xsl:variable name="_titles"><xsl:apply-templates select="document(@href,/)//title"/></xsl:variable><xsl:if test="$_titles = $_this_titles"><xsl:value-of select="position()"/></xsl:if></xsl:for-each></xsl:for-each></xsl:template><xsl:template name="bk:write_navi"><xsl:if test="string-length($bk:toc_url) &gt; 0"><nav class="navi"><span class="go-page to-previous"><xsl:choose><xsl:when test="string-length($bk:previous_page_url) = 0"><a class="link disabled"><xsl:value-of select="$bk:default_navi_prev"/></a></xsl:when><xsl:otherwise><a class="link" href="{$bk:previous_page_url}"><xsl:value-of select="$bk:default_navi_prev"/></a></xsl:otherwise></xsl:choose></span><span class="go-page to-toc"><a class="link" href="{$bk:toc_url}"><xsl:value-of select="$bk:default_navi_toc"/></a></span><span class="go-page to-next"><xsl:choose><xsl:when test="string-length($bk:next_page_url) = 0"><a class="link disabled"><xsl:value-of select="$bk:default_navi_next"/></a></xsl:when><xsl:otherwise><a class="link" href="{$bk:next_page_url}"><xsl:value-of select="$bk:default_navi_next"/></a></xsl:otherwise></xsl:choose></span></nav></xsl:if></xsl:template><xsl:template name="bk:write_navi_header"><xsl:call-template name="bk:write_navi"/></xsl:template><xsl:template name="bk:write_navi_footer"><xsl:call-template name="bk:write_navi"/></xsl:template><xsl:template name="bk:count_until_prev_page"><xsl:param name="chapter_type"/><xsl:param name="page_index" select="$bk:page_index"/><xsl:choose><xsl:when test="string-length($bk:toc_url) &gt; 0"><xsl:for-each select="document($bk:toc_url,/)/xslbook/toc[1]"><xsl:value-of select="count(document((.//page)[position() &lt; $page_index]/@href, /)/xslbook/*[local-name() = $chapter_type])"/></xsl:for-each></xsl:when><xsl:otherwise><xsl:value-of select="0"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template match="p|br|b|i|u"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:element name="{name()}"><xsl:for-each select="attribute::*"><xsl:attribute name="{name()}"><xsl:value-of select="."/></xsl:attribute></xsl:for-each><xsl:apply-templates><xsl:with-param name="data_url" select="$_data_url"/></xsl:apply-templates></xsl:element></xsl:template><xsl:template match="preface|chapter|appendix|postface"><xsl:param name="data_url"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_chapter_type" select="local-name()"/><xsl:variable name="_chapter_index"><xsl:call-template name="bk:get_chapter_index"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$_chapter_type"/></xsl:call-template></xsl:variable><section class="{$_chapter_type}"><xsl:call-template name="bk:set_id"/><xsl:call-template name="bk:write_chapter_title"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$_chapter_type"/><xsl:with-param name="chapter_index" select="$_chapter_index"/></xsl:call-template><xsl:apply-templates select="body|toc|clause"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$_chapter_type"/><xsl:with-param name="chapter_index" select="$_chapter_index"/></xsl:apply-templates></section></xsl:template><xsl:template name="bk:get_chapter_index"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="page_index" select="$bk:page_index"/><xsl:choose><xsl:when test="$chapter_type = 'preface'"><xsl:if test="string-length($bk:preface_index_format) &gt; 0"><xsl:call-template name="bk:format_chapter_index"><xsl:with-param name="index_format" select="$bk:preface_index_format"/><xsl:with-param name="index_in_page"><xsl:number level="multiple" format="1" count="preface"/></xsl:with-param><xsl:with-param name="count_until_prev_page"><xsl:call-template name="bk:count_until_prev_page"><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="page_index" select="$page_index"/></xsl:call-template></xsl:with-param></xsl:call-template></xsl:if></xsl:when><xsl:when test="$chapter_type = 'postface'"><xsl:if test="string-length($bk:postface_index_format) &gt; 0"><xsl:call-template name="bk:format_chapter_index"><xsl:with-param name="index_format" select="$bk:postface_index_format"/><xsl:with-param name="index_in_page"><xsl:number level="multiple" format="1" count="postface"/></xsl:with-param><xsl:with-param name="count_until_prev_page"><xsl:call-template name="bk:count_until_prev_page"><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="page_index" select="$page_index"/></xsl:call-template></xsl:with-param></xsl:call-template></xsl:if></xsl:when><xsl:when test="$chapter_type = 'appendix'"><xsl:if test="string-length($bk:appendix_index_format) &gt; 0"><xsl:call-template name="bk:format_chapter_index"><xsl:with-param name="index_format" select="$bk:appendix_index_format"/><xsl:with-param name="index_in_page"><xsl:number level="multiple" format="1" count="appendix"/></xsl:with-param><xsl:with-param name="count_until_prev_page"><xsl:call-template name="bk:count_until_prev_page"><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="page_index" select="$page_index"/></xsl:call-template></xsl:with-param></xsl:call-template></xsl:if></xsl:when><xsl:otherwise><xsl:if test="string-length($bk:chapter_index_format) &gt; 0"><xsl:call-template name="bk:format_chapter_index"><xsl:with-param name="index_format" select="$bk:chapter_index_format"/><xsl:with-param name="index_in_page"><xsl:number level="multiple" format="1" count="chapter"/></xsl:with-param><xsl:with-param name="count_until_prev_page"><xsl:call-template name="bk:count_until_prev_page"><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="page_index" select="$page_index"/></xsl:call-template></xsl:with-param></xsl:call-template></xsl:if></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="bk:format_chapter_index"><xsl:param name="count_until_prev_page" select="'0'"/><xsl:param name="index_in_page"/><xsl:param name="index_format"/><xsl:variable name="_n" select="$count_until_prev_page + $index_in_page"/><xsl:number format="{$index_format}" value="$_n"/></xsl:template><xsl:template name="bk:write_chapter_title"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><h2 class="title"><span class="index"><xsl:value-of select="$chapter_index"/></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></h2></xsl:template><xsl:template match="clause"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><section class="clause"><xsl:call-template name="bk:set_id"/><xsl:call-template name="bk:write_clause_title"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:call-template><xsl:apply-templates select="body|toc|section"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:apply-templates></section></xsl:template><xsl:template name="bk:write_clause_title"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><h3 class="title"><span class="index"><xsl:value-of select="$chapter_index"/><xsl:if test="string-length($chapter_index) &gt; 0"><xsl:number level="multiple" count="clause" format="{$bk:clause_index_format}"/></xsl:if></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></h3></xsl:template><xsl:template match="section"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><section class="section"><xsl:call-template name="bk:set_id"/><xsl:call-template name="bk:write_section_title"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:call-template><xsl:apply-templates select="body|toc|section"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:apply-templates></section></xsl:template><xsl:template name="bk:write_section_title"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><h4 class="title"><span class="index"><xsl:value-of select="$chapter_index"/><xsl:if test="string-length($chapter_index) &gt; 0"><xsl:number level="multiple" count="clause|section" format="{$bk:clause_index_format}{$bk:section_index_format}"/></xsl:if></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></h4></xsl:template><xsl:template match="toc"><xsl:param name="data_url"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:variable name="_data_url"><xsl:call-template name="bk:get_data_url"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template></xsl:variable><xsl:variable name="_toc_target"><xsl:call-template name="bk:get_toc_target"><xsl:with-param name="default_target" select="$bk:default_toc_target"/></xsl:call-template></xsl:variable><xsl:variable name="_is_toc_page"><xsl:if test="string-length($bk:toc_url) &gt; 0"><xsl:if test="boolean(.//page)"><xsl:value-of select="generate-id(document($bk:page_url,/)) = generate-id(document($bk:toc_url,/))"/></xsl:if></xsl:if></xsl:variable><nav class="toc"><xsl:call-template name="bk:set_id"/><xsl:call-template name="bk:write_toc_title"><xsl:with-param name="data_url" select="$data_url"/></xsl:call-template><xsl:choose><xsl:when test="$_is_toc_page = 'true'"><xsl:call-template name="bk:write_toc_in_page_or_part"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="toc_target" select="$_toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:for-each select=".."><xsl:call-template name="bk:write_toc_in_page"><xsl:with-param name="data_url" select="$_data_url"/><xsl:with-param name="toc_target" select="$_toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></nav></xsl:template><xsl:template name="bk:write_toc_in_page_or_part"><xsl:param name="data_url"/><xsl:param name="toc_target"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:for-each select="part|page"><xsl:variable name="_gid" select="generate-id()"/><xsl:choose><xsl:when test="local-name() = 'part'"><h3 class="title"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></h3><xsl:call-template name="bk:write_toc_in_page_or_part"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/></xsl:call-template></xsl:when><xsl:otherwise><xsl:variable name="_page_index" select="count(//*[generate-id() = $_gid]/preceding::page) +1"/><xsl:variable name="_page_url" select="@href"/><xsl:for-each select="document(@href,/)/xslbook"><xsl:call-template name="bk:write_toc_in_page"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_index" select="$_page_index"/><xsl:with-param name="page_url" select="$_page_url"/></xsl:call-template></xsl:for-each></xsl:otherwise></xsl:choose></xsl:for-each></xsl:template><xsl:template name="bk:write_toc_in_page"><xsl:param name="data_url"/><xsl:param name="toc_target"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:param name="page_index" select="$bk:page_index"/><xsl:param name="page_url" select="$bk:page_url"/><xsl:choose><xsl:when test="local-name() = 'xslbook'"><xsl:call-template name="bk:write_toc_of_chapter"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="page_index" select="$page_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></xsl:when><xsl:when test="local-name(..) = 'xslbook'"><xsl:call-template name="bk:write_toc_of_clause"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></xsl:when><xsl:when test="local-name() = 'clause' or local-name() = 'section'"><xsl:call-template name="bk:write_toc_of_section"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></xsl:when></xsl:choose></xsl:template><xsl:template name="bk:get_toc_target"><xsl:param name="default_target"/><xsl:choose><xsl:when test="string-length(@target) &gt; 0"><xsl:value-of select="concat('|', @target, '|')"/></xsl:when><xsl:otherwise><xsl:value-of select="$default_target"/></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="bk:write_toc_title"><xsl:param name="data_url"/><xsl:choose><xsl:when test="boolean(title)"><h2 class="title"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></h2></xsl:when><xsl:otherwise><h2 class="title"><xsl:value-of select="$bk:default_toc_title"/></h2></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="bk:write_toc_of_chapter"><xsl:param name="data_url"/><xsl:param name="toc_target"/><xsl:param name="page_index"/><xsl:param name="page_url"/><xsl:for-each select="preface|chapter|appendix|postface"><xsl:variable name="_chapter_id"><xsl:call-template name="bk:get_id"/></xsl:variable><xsl:variable name="_chapter_type" select="local-name()"/><xsl:variable name="_chapter_index"><xsl:call-template name="bk:get_chapter_index"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="chapter_type" select="$_chapter_type"/><xsl:with-param name="page_index" select="$page_index"/></xsl:call-template></xsl:variable><xsl:choose><xsl:when test="contains($toc_target, concat('|',$_chapter_type,'|'))"><div class="{$_chapter_type}"><a class="title link"><xsl:attribute name="href"><xsl:value-of select="concat($page_url, '#', $_chapter_id)"/></xsl:attribute><span class="index"><xsl:value-of select="$_chapter_index"/></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></a><xsl:call-template name="bk:write_toc_of_clause"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$_chapter_type"/><xsl:with-param name="chapter_index" select="$_chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></div></xsl:when><xsl:when test="contains($toc_target, concat('|~',$_chapter_type,'|'))"><xsl:call-template name="bk:write_toc_of_clause"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$_chapter_type"/><xsl:with-param name="chapter_index" select="$_chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></xsl:when></xsl:choose></xsl:for-each></xsl:template><xsl:template name="bk:write_toc_of_clause"><xsl:param name="data_url"/><xsl:param name="toc_target"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:param name="page_url"/><xsl:choose><xsl:when test="contains($toc_target, '|clause|')"><xsl:for-each select="clause"><xsl:variable name="_clause_index"><xsl:if test="string-length($chapter_index) &gt; 0"><xsl:value-of select="$chapter_index"/><xsl:number level="multiple" count="clause" format="{$bk:clause_index_format}"/></xsl:if></xsl:variable><xsl:variable name="_clause_id"><xsl:call-template name="bk:get_id"/></xsl:variable><div class="clause"><a class="title link"><xsl:attribute name="href"><xsl:value-of select="concat($page_url, '#', $_clause_id)"/></xsl:attribute><span class="index"><xsl:value-of select="$_clause_index"/></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></a><xsl:call-template name="bk:write_toc_of_section"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></div></xsl:for-each></xsl:when><xsl:when test="contains($toc_target, '|~clause|')"><xsl:for-each select="clause"><xsl:call-template name="bk:write_toc_of_section"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></xsl:for-each></xsl:when></xsl:choose></xsl:template><xsl:template name="bk:write_toc_of_section"><xsl:param name="data_url"/><xsl:param name="toc_target"/><xsl:param name="chapter_type"/><xsl:param name="chapter_index"/><xsl:param name="page_url"/><xsl:if test="contains($toc_target, '|section|')"><xsl:for-each select="section"><xsl:variable name="_section_index"><xsl:if test="string-length($chapter_index) &gt; 0"><xsl:value-of select="$chapter_index"/><xsl:number level="multiple" count="clause" format="{$bk:clause_index_format}"/><xsl:number level="multiple" count="section" format="{$bk:section_index_format}"/></xsl:if></xsl:variable><xsl:variable name="_section_id"><xsl:call-template name="bk:get_id"/></xsl:variable><div class="section"><a class="title link"><xsl:attribute name="href"><xsl:value-of select="concat($page_url, '#', $_section_id)"/></xsl:attribute><span class="index"><xsl:value-of select="$_section_index"/></span><span class="label"><xsl:apply-templates select="title"><xsl:with-param name="data_url" select="$data_url"/></xsl:apply-templates></span></a><xsl:call-template name="bk:write_toc_of_section"><xsl:with-param name="data_url" select="$data_url"/><xsl:with-param name="toc_target" select="$toc_target"/><xsl:with-param name="chapter_type" select="$chapter_type"/><xsl:with-param name="chapter_index" select="$chapter_index"/><xsl:with-param name="page_url" select="$page_url"/></xsl:call-template></div></xsl:for-each></xsl:if></xsl:template><xsl:template name="ut:get_dir_from_url"><xsl:param name="url"/><xsl:choose><xsl:when test="not(contains($url, '/'))">.</xsl:when><xsl:otherwise><xsl:call-template name="ut:_get_dir_from_url_r"><xsl:with-param name="url" select="$url"/></xsl:call-template></xsl:otherwise></xsl:choose></xsl:template><xsl:template name="ut:_get_dir_from_url_r"><xsl:param name="url"/><xsl:value-of select="substring-before($url, '/')"/><xsl:variable name="suburl" select="substring-after($url, '/')"/><xsl:if test="string-length($suburl) &gt; 0"><xsl:variable name="subdir"><xsl:call-template name="ut:_get_dir_from_url_r"><xsl:with-param name="url" select="$suburl"/></xsl:call-template></xsl:variable><xsl:if test="string-length($subdir) &gt; 0"><xsl:value-of select="concat('/', $subdir)"/></xsl:if></xsl:if></xsl:template><xsl:template name="ut:get_xsl_url"><xsl:param name="pi" select="/processing-instruction('xml-stylesheet')"/><xsl:variable name="QUOT">"</xsl:variable><xsl:variable name="APOS">'</xsl:variable><xsl:variable name="s1" select="substring-after($pi, 'href')"/><xsl:if test="normalize-space(substring-before($s1, '=')) = ''"><xsl:variable name="s2" select="substring-after($s1, '=')"/><xsl:choose><xsl:when test="substring($s2, 1, 1) = $QUOT"><xsl:value-of select="translate(substring-before(substring-after($s2, $QUOT), $QUOT), '\', '/')"/></xsl:when><xsl:when test="substring($s2, 1, 1) = $APOS"><xsl:value-of select="translate(substring-before(substring-after($s2, $APOS), $APOS), '\', '/')"/></xsl:when><xsl:otherwise><xsl:variable name="s3" select="normalize-space($s2)"/><xsl:choose><xsl:when test="substring($s3, 1, 1) = $QUOT"><xsl:value-of select="translate(substring-before(substring-after($s2, $QUOT), $QUOT), '\', '/')"/></xsl:when><xsl:when test="substring($s3, 1, 1) = $APOS"><xsl:value-of select="translate(substring-before(substring-after($s2, $APOS), $APOS), '\', '/')"/></xsl:when></xsl:choose></xsl:otherwise></xsl:choose></xsl:if></xsl:template></xsl:stylesheet>